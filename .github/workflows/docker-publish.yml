name: Docker

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

on:
  push:
    branches: [ "main" ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - name: checkout code 
      uses: actions/checkout@v3

    - name: Set the Date as Tag
      id: set_tag
      run: echo "TAG=V-$(date +%y.%m.%d)" >> $GITHUB_ENV

    - name: Building the Docker image
      run: docker build . --file Dockerfile --tag myapp:latest

    - name: Login to Docker Hub
      run: |
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    - name: Tagginf and Pushing Docker Image (latest)
      run: |
        docker tag myapp:latest ${{ secrets.DOCKER_USERNAME }}/myapp:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/myapp:latest

    - name: Tag and Push Docker Image (with timestamp tag)
      run: |
        docker tag myapp:latest ${{ secrets.DOCKER_USERNAME }}/myapp:${{ env.TAG }}
        docker push ${{ secrets.DOCKER_USERNAME }}/myapp:${{ env.TAG }}